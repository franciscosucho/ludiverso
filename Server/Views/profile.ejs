<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('head.ejs') %>
    <title>Perfil de Usuario</title>
    <link rel="stylesheet" href="/Estilo/profile.css">
</head>
<body>
   <%- include('headers/header_simple') %>
    <main id="profile">
        <h2>Mi Perfil</h2>
        <section class="profile-container">
            <div class="profile-header">
                <div class="profile-avatar">
                    <i class="fa-solid fa-user-circle"></i>
                </div>
                <h3><%= user.nombre %> <%= user.apellido %></h3>
                <p class="user-role"><%= user.rol %></p>
            </div>
            
            <div class="profile-info">
                <form action="/actualizar_perfil" method="POST" class="profile-form">
                    <input type="hidden" name="usuario_id" value="<%= user.usuario_id %>">
                    
                    <div class="form-group">
                        <label for="nombre">Nombre</label>
                        <input type="text" id="nombre" name="nombre" value="<%= user.nombre %>" required readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="apellido">Apellido</label>
                        <input type="text" id="apellido" name="apellido" value="<%= user.apellido %>" required readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="nombre_usuario">Nombre de Usuario</label>
                        <input type="text" id="nombre_usuario" name="nombre_usuario" value="<%= user.nombre_usuario %>" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" value="<%= user.email %>" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Nueva ContraseÃ±a</label>
                        <input type="password" id="password" name="password" placeholder="Dejar en blanco para mantener la actual">
                    </div>
                    <div class="form-group">
                        <label for="daltonismo">Daltonismo</label>
                        <%
                        var modo_daltonismo= ['no_daltonico','protanopia','deuteranopia','tritanopia','protanomaly','deuteranomaly','tritanomaly','acromatopsia','acromatomaly','otro']
                        %>
                        <select name="daltonismo" id="daltonismo"> 
                            <% modo_daltonismo.forEach((dalto) => { %> 
                                <option value="<%= dalto %>" <%= user.daltonismo === dalto ? 'selected' : '' %>>
                                <% if(dalto=="no_daltonico"){ %>
                                    No daltonico
                                    <%} else{ %>
                                        <%= dalto %>
                                        <%}%>
                                  
                                </option>
                            <% }) %>
                        </select>
                    </div>
                    <button type="submit" class="btn-save">Guardar Cambios</button>
                </form>
            </div>
            
            <div class="profile-stats">
                <h4>EstadÃ­sticas Generales</h4>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-value"><%= stats.juegosJugados || 0 %></span>
                        <span class="stat-label">Total de Partidas</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value"><%= stats.puntosTotales || 0 %></span>
                        <span class="stat-label">Puntos Totales</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value"><%= stats.ranking || 'N/A' %></span>
                        <span class="stat-label">PosiciÃ³n Global</span>
                    </div>
                </div>
                
                <h4 style="margin-top: 2rem;">EstadÃ­sticas por Juego</h4>
                <div class="game-stats-grid">
                    <div class="game-stat-card">
                        <h5>ðŸŽ® Memory Card</h5>
                        <div class="game-stat-details">
                            <p><strong>Niveles Completados:</strong> <span id="memory-levels">Cargando...</span></p>
                            <p><strong>Puntaje Total:</strong> <span id="memory-score">Cargando...</span></p>
                        </div>
                    </div>
                    
                    <div class="game-stat-card">
                        <h5>ðŸ”¤ Wordle</h5>
                        <div class="game-stat-details">
                            <p><strong>Mejor Aciertos:</strong> <span id="wordle-best">Cargando...</span></p>
                            <p><strong>Mejor Tiempo:</strong> <span id="wordle-time">Cargando...</span></p>
                        </div>
                    </div>
                    
                    <div class="game-stat-card">
                        <h5>ðŸŽ¯ Ahorcado</h5>
                        <div class="game-stat-details">
                            <p><strong>Victorias:</strong> <span id="ahorcado-wins">Cargando...</span></p>
                            <p><strong>Mejor Tiempo:</strong> <span id="ahorcado-time">Cargando...</span></p>
                        </div>
                    </div>
                    
                    <div class="game-stat-card">
                        <h5>ðŸ§© Rompecabezas</h5>
                        <div class="game-stat-details">
                            <p><strong>Niveles Completados:</strong> <span id="puzzle-levels">Cargando...</span></p>
                            <p><strong>Mejor Tiempo:</strong> <span id="puzzle-time">Cargando...</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <%- include('footer.ejs') %>
    
    <script src="/Scripts/profile.js"></script>
    <script>
        // Cargar estadÃ­sticas detalladas por juego
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Cargando estadÃ­sticas...');
            
            // Primero probar las estadÃ­sticas generales
            fetch('/test-stats')
                .then(response => response.json())
                .then(testData => {
                    console.log('Datos de prueba de estadÃ­sticas generales:', testData);
                    
                    // Actualizar estadÃ­sticas generales si es necesario
                    if (testData.stats) {
                        const statValues = document.querySelectorAll('.stat-value');
                        console.log('Elementos de estadÃ­sticas encontrados:', statValues.length);
                        console.log('Elementos:', statValues);
                        
                        if (statValues.length >= 2) {
                            statValues[0].textContent = testData.stats.juegosJugados || 0;
                            statValues[1].textContent = testData.stats.puntosTotales || 0;
                            console.log('EstadÃ­sticas generales actualizadas:', testData.stats);
                        } else {
                            console.log('No se encontraron suficientes elementos de estadÃ­sticas');
                        }
                    }
                    
                    // Luego cargar estadÃ­sticas por juego
                    return fetch('/profile-stats');
                })
                .then(response => {
                    console.log('Respuesta del servidor:', response);
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Datos recibidos:', data);
                    
                    // Actualizar estadÃ­sticas de Memory Card
                    document.getElementById('memory-levels').textContent = data.memory.niveles_completados || 0;
                    document.getElementById('memory-score').textContent = data.memory.puntaje_total || 0;
                    
                    // Actualizar estadÃ­sticas de Wordle
                    document.getElementById('wordle-best').textContent = data.wordle.mejor_aciertos || 0;
                    document.getElementById('wordle-time').textContent = data.wordle.mejor_tiempo > 0 ? data.wordle.mejor_tiempo + ' seg' : 'N/A';
                    
                    // Actualizar estadÃ­sticas de Ahorcado
                    document.getElementById('ahorcado-wins').textContent = data.ahorcado.victorias || 0;
                    document.getElementById('ahorcado-time').textContent = data.ahorcado.mejor_tiempo > 0 ? data.ahorcado.mejor_tiempo + ' seg' : 'N/A';
                    
                    // Actualizar estadÃ­sticas de Rompecabezas
                    document.getElementById('puzzle-levels').textContent = data.puzzle.niveles_completados || 0;
                    document.getElementById('puzzle-time').textContent = data.puzzle.mejor_tiempo > 0 ? data.puzzle.mejor_tiempo + ' seg' : 'N/A';
                })
                .catch(error => {
                    console.error('Error al cargar estadÃ­sticas:', error);
                    // Mostrar valores por defecto en lugar de error
                    const elements = ['memory-levels', 'memory-score', 'wordle-best', 'wordle-time', 'ahorcado-wins', 'ahorcado-time', 'puzzle-levels', 'puzzle-time'];
                    elements.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = '0';
                        }
                    });
                });
        });
    </script>
</body>
</html> 